# deode_harp_plugin
Plugin interface to run harp point verification for deode extreme weather cases.

# Prerrequisites:
- An installation of harpv02.2 or higher. Instructions can be found here: https://harphub.github.io/harp_training_2024/get-started.html
- Get the official harp scripts for operational use, available in https://github.com/harphub/oper-harp-verif

# Description:
This plugin needs the config.toml file from the deode run that you want to verify as input. Relevant configuration of the verification paths, etc. must be updated in the file harpverify_plugin.toml. 

To create a verification suite from a config.toml and the harpverify_plugin.toml file, create a file -e.g. called configuration- in the Deode-Workflow home directory, with the following content:

> --config-file
> 
>   /path/to/config.toml
> 
>   /path/to/harpverify_plugin.toml
>
Check for the comments in harpverify_plugin.toml to understand how to set each plugin/user specific variable.

The plugin is used for verification of the DEODE runs by the on-duty team (DUSER=aut6432), which use a specific way of indexing/archiving runs

If you want to use this plugin to run verifications for one of your own cases, set DUSER=HUSER=your_user and USE_OPERATIONAL_INDEXING=no

It is possible to use more than one reference in the verifications. The reference sqlites should all be available in the path set in REF_SQLITES, and the names of the reference models is set in a list in REF_NAME (both variables set in harpverify_plugin.toml)

Currently the harpverify_plugin.toml is set to use the Global Digital Twin (GDT_iekm) and IFS as references, and the path for the sqlites of these references points to where they are routinely generated by DEODE's operational user (aut6432). They are available for dates after Feb,1, 2025. 

Finally, for solving some discrepancies with model units of a few variables between these references and the OD runs, a careful setting of scaling of units must be set in the file verification/set_params.R from oper-harp-verif. A copy of the currently operational one can be found at /home/aut6432/DE_Verification/verif_tools/oper-harp-verif/verification/set_params.R
 
After setting your harpverify_plugin.toml correctly, create and launch the verification suite with these commands: 

> poetry shell
> 
> deode case ?configuration -o verification_suite.toml
> 
> deode start suite --config-file verification_suite.tom
>
Or, alternatively, use the launch_from_user.py script like this:
python3 lauch_from_user.py path_to_harpverify_plugin.toml deode_user experiment_name yyyy mm dd

If everything went fine, a new suite will appear in your ecflow_ui, named just like the deode case, with a family called "Case_point_verification" and tasks to get the verification files, Verify, and save the files conveniently:

![Screenshot from 2024-10-21 10-59-18](https://github.com/user-attachments/assets/f68f5f10-2488-437b-932d-709bd8914d60)

In addition, for automatizing verifications run by the on-duty team, an auxiliar script script is available (launch_from_dcmdb.py) to read new runs betweeen two dates from dcmdb,
download the config files and launch all the suites.

  
